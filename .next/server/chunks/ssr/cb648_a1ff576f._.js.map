{"version":3,"sources":["../../../../../../Desktop/pincher/node_modules/viem/clients/transports/fallback.ts"],"sourcesContent":["import { ExecutionRevertedError } from '../../errors/node.js'\nimport {\n  TransactionRejectedRpcError,\n  UserRejectedRequestError,\n} from '../../errors/rpc.js'\nimport type { ErrorType } from '../../errors/utils.js'\nimport type { Chain } from '../../types/chain.js'\nimport { wait } from '../../utils/wait.js'\n\nimport {\n  type CreateTransportErrorType,\n  createTransport,\n  type Transport,\n  type TransportConfig,\n} from './createTransport.js'\n// TODO: Narrow `method` & `params` types.\nexport type OnResponseFn = (\n  args: {\n    method: string\n    params: unknown[]\n    transport: ReturnType<Transport>\n  } & (\n    | {\n        error?: undefined\n        response: unknown\n        status: 'success'\n      }\n    | {\n        error: Error\n        response?: undefined\n        status: 'error'\n      }\n  ),\n) => void\n\ntype RankOptions = {\n  /**\n   * The polling interval (in ms) at which the ranker should ping the RPC URL.\n   * @default client.pollingInterval\n   */\n  interval?: number | undefined\n  /**\n   * Ping method to determine latency.\n   */\n  ping?: (parameters: {\n    transport: ReturnType<Transport>\n  }) => Promise<unknown> | undefined\n  /**\n   * The number of previous samples to perform ranking on.\n   * @default 10\n   */\n  sampleCount?: number | undefined\n  /**\n   * Timeout when sampling transports.\n   * @default 1_000\n   */\n  timeout?: number | undefined\n  /**\n   * Weights to apply to the scores. Weight values are proportional.\n   */\n  weights?:\n    | {\n        /**\n         * The weight to apply to the latency score.\n         * @default 0.3\n         */\n        latency?: number | undefined\n        /**\n         * The weight to apply to the stability score.\n         * @default 0.7\n         */\n        stability?: number | undefined\n      }\n    | undefined\n}\n\nexport type FallbackTransportConfig = {\n  /** The key of the Fallback transport. */\n  key?: TransportConfig['key'] | undefined\n  /** The name of the Fallback transport. */\n  name?: TransportConfig['name'] | undefined\n  /** Toggle to enable ranking, or rank options. */\n  rank?: boolean | RankOptions | undefined\n  /** The max number of times to retry. */\n  retryCount?: TransportConfig['retryCount'] | undefined\n  /** The base delay (in ms) between retries. */\n  retryDelay?: TransportConfig['retryDelay'] | undefined\n  /** Callback on whether an error should throw or try the next transport in the fallback. */\n  shouldThrow?: (error: Error) => boolean | undefined\n}\n\nexport type FallbackTransport<\n  transports extends readonly Transport[] = readonly Transport[],\n> = Transport<\n  'fallback',\n  {\n    onResponse: (fn: OnResponseFn) => void\n    transports: {\n      [key in keyof transports]: ReturnType<transports[key]>\n    }\n  }\n>\n\nexport type FallbackTransportErrorType = CreateTransportErrorType | ErrorType\n\nexport function fallback<const transports extends readonly Transport[]>(\n  transports_: transports,\n  config: FallbackTransportConfig = {},\n): FallbackTransport<transports> {\n  const {\n    key = 'fallback',\n    name = 'Fallback',\n    rank = false,\n    shouldThrow: shouldThrow_ = shouldThrow,\n    retryCount,\n    retryDelay,\n  } = config\n  return (({ chain, pollingInterval = 4_000, timeout, ...rest }) => {\n    let transports = transports_\n\n    let onResponse: OnResponseFn = () => {}\n\n    const transport = createTransport(\n      {\n        key,\n        name,\n        async request({ method, params }) {\n          let includes: boolean | undefined\n\n          const fetch = async (i = 0): Promise<any> => {\n            const transport = transports[i]({\n              ...rest,\n              chain,\n              retryCount: 0,\n              timeout,\n            })\n            try {\n              const response = await transport.request({\n                method,\n                params,\n              } as any)\n\n              onResponse({\n                method,\n                params: params as unknown[],\n                response,\n                transport,\n                status: 'success',\n              })\n\n              return response\n            } catch (err) {\n              onResponse({\n                error: err as Error,\n                method,\n                params: params as unknown[],\n                transport,\n                status: 'error',\n              })\n\n              if (shouldThrow_(err as Error)) throw err\n\n              // If we've reached the end of the fallbacks, throw the error.\n              if (i === transports.length - 1) throw err\n\n              // Check if at least one other transport includes the method\n              includes ??= transports.slice(i + 1).some((transport) => {\n                const { include, exclude } =\n                  transport({ chain }).config.methods || {}\n                if (include) return include.includes(method)\n                if (exclude) return !exclude.includes(method)\n                return true\n              })\n              if (!includes) throw err\n\n              // Otherwise, try the next fallback.\n              return fetch(i + 1)\n            }\n          }\n          return fetch()\n        },\n        retryCount,\n        retryDelay,\n        type: 'fallback',\n      },\n      {\n        onResponse: (fn: OnResponseFn) => (onResponse = fn),\n        transports: transports.map((fn) => fn({ chain, retryCount: 0 })),\n      },\n    )\n\n    if (rank) {\n      const rankOptions = (typeof rank === 'object' ? rank : {}) as RankOptions\n      rankTransports({\n        chain,\n        interval: rankOptions.interval ?? pollingInterval,\n        onTransports: (transports_) => (transports = transports_ as transports),\n        ping: rankOptions.ping,\n        sampleCount: rankOptions.sampleCount,\n        timeout: rankOptions.timeout,\n        transports,\n        weights: rankOptions.weights,\n      })\n    }\n    return transport\n  }) as FallbackTransport<transports>\n}\n\nexport function shouldThrow(error: Error) {\n  if ('code' in error && typeof error.code === 'number') {\n    if (\n      error.code === TransactionRejectedRpcError.code ||\n      error.code === UserRejectedRequestError.code ||\n      ExecutionRevertedError.nodeMessage.test(error.message) ||\n      error.code === 5000 // CAIP UserRejectedRequestError\n    )\n      return true\n  }\n  return false\n}\n\n/** @internal */\nexport function rankTransports({\n  chain,\n  interval = 4_000,\n  onTransports,\n  ping,\n  sampleCount = 10,\n  timeout = 1_000,\n  transports,\n  weights = {},\n}: {\n  chain?: Chain | undefined\n  interval: RankOptions['interval']\n  onTransports: (transports: readonly Transport[]) => void\n  ping?: RankOptions['ping'] | undefined\n  sampleCount?: RankOptions['sampleCount'] | undefined\n  timeout?: RankOptions['timeout'] | undefined\n  transports: readonly Transport[]\n  weights?: RankOptions['weights'] | undefined\n}) {\n  const { stability: stabilityWeight = 0.7, latency: latencyWeight = 0.3 } =\n    weights\n\n  type SampleData = { latency: number; success: number }\n  type Sample = SampleData[]\n  const samples: Sample[] = []\n\n  const rankTransports_ = async () => {\n    // 1. Take a sample from each Transport.\n    const sample: Sample = await Promise.all(\n      transports.map(async (transport) => {\n        const transport_ = transport({ chain, retryCount: 0, timeout })\n\n        const start = Date.now()\n        let end: number\n        let success: number\n        try {\n          await (ping\n            ? ping({ transport: transport_ })\n            : transport_.request({ method: 'net_listening' }))\n          success = 1\n        } catch {\n          success = 0\n        } finally {\n          end = Date.now()\n        }\n        const latency = end - start\n        return { latency, success }\n      }),\n    )\n\n    // 2. Store the sample. If we have more than `sampleCount` samples, remove\n    // the oldest sample.\n    samples.push(sample)\n    if (samples.length > sampleCount) samples.shift()\n\n    // 3. Calculate the max latency from samples.\n    const maxLatency = Math.max(\n      ...samples.map((sample) =>\n        Math.max(...sample.map(({ latency }) => latency)),\n      ),\n    )\n\n    // 4. Calculate the score for each Transport.\n    const scores = transports\n      .map((_, i) => {\n        const latencies = samples.map((sample) => sample[i].latency)\n        const meanLatency =\n          latencies.reduce((acc, latency) => acc + latency, 0) /\n          latencies.length\n        const latencyScore = 1 - meanLatency / maxLatency\n\n        const successes = samples.map((sample) => sample[i].success)\n        const stabilityScore =\n          successes.reduce((acc, success) => acc + success, 0) /\n          successes.length\n\n        if (stabilityScore === 0) return [0, i]\n        return [\n          latencyWeight * latencyScore + stabilityWeight * stabilityScore,\n          i,\n        ]\n      })\n      .sort((a, b) => b[0] - a[0])\n\n    // 5. Sort the Transports by score.\n    onTransports(scores.map(([, i]) => transports[i]))\n\n    // 6. Wait, and then rank again.\n    await wait(interval)\n    rankTransports_()\n  }\n  rankTransports_()\n}\n"],"names":[],"mappings":"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"}