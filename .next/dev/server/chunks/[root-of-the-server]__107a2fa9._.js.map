{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/jhinresh/Desktop/pincher/lib/server-wallet.ts"],"sourcesContent":["import { createWalletClient, createPublicClient, http } from \"viem\";\nimport { privateKeyToAccount } from \"viem/accounts\";\nimport { baseSepolia } from \"viem/chains\";\n\n// Reuse the Faucet Key for the Agent (or a dedicated AGENT_PRIVATE_KEY)\nconst PRIVATE_KEY = process.env.FAUCET_PRIVATE_KEY as `0x${string}`;\n\nif (!PRIVATE_KEY) {\n  console.warn(\"⚠️ AGENT WARNING: FAUCET_PRIVATE_KEY is missing. Agent wallet will fail.\");\n}\n\n// 1. Account Setup\nlet account = null;\ntry {\n  let key = process.env.FAUCET_PRIVATE_KEY;\n  console.log(\"Debug: FAUCET_PRIVATE_KEY length:\", key ? key.length : \"undefined\");\n\n  // Auto-fix: Prepend 0x if missing\n  if (key && !key.startsWith(\"0x\")) {\n    console.log(\"⚠️ Auto-fixing key: Prepending '0x'\");\n    key = `0x${key}`;\n  }\n\n  if (key && key.startsWith(\"0x\")) {\n    account = privateKeyToAccount(key as `0x${string}`);\n  } else {\n    console.warn(\"❌ Key missing or invalid format (must start with 0x)\");\n  }\n} catch (e) {\n  console.error(\"❌ Agent Wallet Error: Invalid Private Key format. Check .env.local\");\n}\nexport const agentAccount = account;\n\n// 2. Public Client (Read Blockchain)\nexport const publicClient = createPublicClient({\n  chain: baseSepolia,\n  transport: http(),\n});\n\n// 3. Wallet Client (Write/Sign Transactions)\nexport const agentWallet = agentAccount\n  ? createWalletClient({\n      account: agentAccount!,\n      chain: baseSepolia,\n      transport: http(),\n    })\n  : (null as any);\n\n// Helper: Check Agent Balance\n/**\n *\n */\nexport async function getAgentBalance() {\n  if (!agentAccount) return \"0\";\n  const balance = await publicClient.getBalance({ address: agentAccount.address });\n  // Return formatted string if needed, or keeping explicit bigint elsewhere\n  return balance;\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AACA;AACA;;;;AAEA,wEAAwE;AACxE,MAAM,cAAc,QAAQ,GAAG,CAAC,kBAAkB;AAElD,IAAI,CAAC,aAAa;IAChB,QAAQ,IAAI,CAAC;AACf;AAEA,mBAAmB;AACnB,IAAI,UAAU;AACd,IAAI;IACF,IAAI,MAAM,QAAQ,GAAG,CAAC,kBAAkB;IACxC,QAAQ,GAAG,CAAC,qCAAqC,MAAM,IAAI,MAAM,GAAG;IAEpE,kCAAkC;IAClC,IAAI,OAAO,CAAC,IAAI,UAAU,CAAC,OAAO;QAChC,QAAQ,GAAG,CAAC;QACZ,MAAM,CAAC,EAAE,EAAE,KAAK;IAClB;IAEA,IAAI,OAAO,IAAI,UAAU,CAAC,OAAO;QAC/B,UAAU,IAAA,8MAAmB,EAAC;IAChC,OAAO;QACL,QAAQ,IAAI,CAAC;IACf;AACF,EAAE,OAAO,GAAG;IACV,QAAQ,KAAK,CAAC;AAChB;AACO,MAAM,eAAe;AAGrB,MAAM,eAAe,IAAA,2MAAkB,EAAC;IAC7C,OAAO,2MAAW;IAClB,WAAW,IAAA,6LAAI;AACjB;AAGO,MAAM,cAAc,eACvB,IAAA,2MAAkB,EAAC;IACjB,SAAS;IACT,OAAO,2MAAW;IAClB,WAAW,IAAA,6LAAI;AACjB,KACC;AAME,eAAe;IACpB,IAAI,CAAC,cAAc,OAAO;IAC1B,MAAM,UAAU,MAAM,aAAa,UAAU,CAAC;QAAE,SAAS,aAAa,OAAO;IAAC;IAC9E,0EAA0E;IAC1E,OAAO;AACT"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/jhinresh/Desktop/pincher/app/api/escrow/release/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { publicClient, agentWallet, agentAccount } from \"@/lib/server-wallet\";\nimport { parseUnits, encodeFunctionData, erc20Abi } from \"viem\";\n\n// Constants\nconst USDC_ADDRESS = \"0x036CbD53842c5426634e7929541eC2318f3dCF7e\";\nconst RIDE_PRICE = \"0.01\"; // 0.01 USDC\nconst RIDE_PRICE_UNITS = parseUnits(RIDE_PRICE, 6);\n\n/**\n *\n * @param req\n */\nexport async function POST(req: Request) {\n  try {\n    const { rideId } = await req.json();\n\n    if (!rideId) {\n      return NextResponse.json({ error: \"Missing rideId\" }, { status: 400 });\n    }\n\n    // 1. Fetch Ride Data\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n    const supabase = createClient(supabaseUrl, supabaseKey);\n\n    const { data: ride, error: dbError } = await supabase\n      .from(\"rides\")\n      .select(\"*\")\n      .eq(\"id\", rideId)\n      .single();\n\n    if (dbError || !ride) {\n      return NextResponse.json({ error: \"Ride not found\" }, { status: 404 });\n    }\n\n    if (ride.status !== \"escrow_holding\") {\n      return NextResponse.json({ error: \"Ride not in escrow/holding state\" }, { status: 400 });\n    }\n\n    const driverAddress = ride.user_address as `0x${string}`;\n\n    // 2. Calculate Payout (95%)\n    // 0.01 USDC * 0.95 = 0.0095 USDC\n    const payoutAmount = (RIDE_PRICE_UNITS * 95n) / 100n;\n\n    console.log(`[Escrow] Releasing payout to ${driverAddress}...`);\n\n    // 3. Execute Transfer (Agent -> Driver)\n    if (!agentAccount) {\n      throw new Error(\"Agent account not configured\");\n    }\n\n    const hash = await agentWallet.writeContract({\n      address: USDC_ADDRESS,\n      abi: erc20Abi,\n      functionName: \"transfer\",\n      args: [driverAddress, payoutAmount],\n    });\n\n    console.log(`[Escrow] Payout sent! Hash: ${hash}`);\n\n    // Wait for confirmation? Optimistic update is fine for UI speed, but better to be safe?\n    // Let's assume successful submission is enough for now.\n\n    // 4. Update DB\n    const { error: updateError } = await supabase\n      .from(\"rides\")\n      .update({ status: \"completed\" })\n      .eq(\"id\", rideId);\n\n    if (updateError) {\n      console.error(\"Failed to update status after payout\", updateError);\n      // CRITICAL: In real app, we need mechanism to retry status update if payment sent\n    }\n\n    return NextResponse.json({\n      success: true,\n      payoutHash: hash,\n      driverAmount: \"0.0095 USDC\",\n    });\n  } catch (error: any) {\n    console.error(\"Release Error:\", error);\n    return NextResponse.json({ error: error.message || \"Internal Error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AAAA;;;;;AAEA,YAAY;AACZ,MAAM,eAAe;AACrB,MAAM,aAAa,QAAQ,YAAY;AACvC,MAAM,mBAAmB,IAAA,iMAAU,EAAC,YAAY;AAMzC,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QAEjC,IAAI,CAAC,QAAQ;YACX,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,qBAAqB;QACrB,MAAM;QACN,MAAM;QACN,MAAM,WAAW,IAAA,sNAAY,EAAC,aAAa;QAE3C,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SAC1C,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,WAAW,CAAC,MAAM;YACpB,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,KAAK,MAAM,KAAK,kBAAkB;YACpC,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QACxF;QAEA,MAAM,gBAAgB,KAAK,YAAY;QAEvC,4BAA4B;QAC5B,iCAAiC;QACjC,MAAM,eAAe,AAAC,mBAAmB,GAAG,GAAI,IAAI;QAEpD,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,cAAc,GAAG,CAAC;QAE9D,wCAAwC;QACxC,IAAI,CAAC,+JAAY,EAAE;YACjB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,OAAO,MAAM,8JAAW,CAAC,aAAa,CAAC;YAC3C,SAAS;YACT,KAAK,qLAAQ;YACb,cAAc;YACd,MAAM;gBAAC;gBAAe;aAAa;QACrC;QAEA,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,MAAM;QAEjD,wFAAwF;QACxF,wDAAwD;QAExD,eAAe;QACf,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,SACL,MAAM,CAAC;YAAE,QAAQ;QAAY,GAC7B,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,wCAAwC;QACtD,kFAAkF;QACpF;QAEA,OAAO,sKAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,YAAY;YACZ,cAAc;QAChB;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO,IAAI;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACvF;AACF"}}]
}